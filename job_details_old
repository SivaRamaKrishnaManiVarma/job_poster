<?php
require_once 'includes/config.php';
require_once 'includes/functions.php';
require_once 'includes/master-data-functions.php';

// Get job by slug or ID (fallback for old links)
$slug = isset($_GET['slug']) ? trim($_GET['slug']) : '';
$jobId = isset($_GET['id']) ? (int)$_GET['id'] : 0;

if (empty($slug) && $jobId === 0) {
    header('Location: /job_poster/');
    exit;
}

// Prepare query based on what's available
if (!empty($slug)) {
    $whereClause = "j.slug = ? AND j.is_active = 1";
    $param = $slug;
} else {
    $whereClause = "j.id = ? AND j.is_active = 1";
    $param = $jobId;
}

// Get job details with ALL master data including NEW fields
$stmt = $pdo->prepare("SELECT j.*, 
    c.category_name, c.icon as category_icon,
    w.mode_name, w.icon as work_mode_icon,
    e.type_name, e.icon as employment_icon,
    ex.level_name, ex.icon as experience_icon,
    s.state_name,
    d.department_name, d.department_type,
    q.qualification_name, q.qualification_level
    FROM jobs j
    LEFT JOIN master_job_categories c ON j.job_category_id = c.id
    LEFT JOIN master_work_modes w ON j.work_mode_id = w.id
    LEFT JOIN master_employment_types e ON j.employment_type_id = e.id
    LEFT JOIN master_experience_levels ex ON j.experience_level_id = ex.id
    LEFT JOIN master_states s ON j.state_id = s.id
    LEFT JOIN master_departments d ON j.department_id = d.id
    LEFT JOIN master_qualifications q ON j.min_qualification_id = q.id
    WHERE $whereClause");
$stmt->execute([$param]);
$job = $stmt->fetch();

// If job not found or inactive, redirect
if (!$job) {
    header('Location: /job_poster/');
    exit;
}

// If accessed by ID, redirect to slug URL (for SEO)
if ($jobId > 0 && !empty($job['slug'])) {
    header('Location: /job_poster/jobs/' . urlencode($job['slug']), true, 301);
    exit;
}

// Check if job is expired
$isExpired = $job['application_deadline'] && strtotime($job['application_deadline']) < strtotime(date('Y-m-d'));

// Calculate days until deadline
$daysUntilDeadline = null;
if ($job['application_deadline']) {
    $deadline = strtotime($job['application_deadline']);
    $today = strtotime(date('Y-m-d'));
    $daysUntilDeadline = floor(($deadline - $today) / (60 * 60 * 24));
}

// Get related jobs (same category, excluding current job)
$relatedJobs = [];
if ($job['job_category_id']) {
    $stmt = $pdo->prepare("SELECT j.slug, j.id, j.title, j.company, j.location, j.posted_date,
        j.total_vacancies, j.application_deadline, j.salary_min, j.description,
        c.category_name, c.icon as category_icon,
        w.mode_name, w.icon as work_mode_icon,
        e.type_name, e.icon as employment_icon,
        ex.level_name, ex.icon as experience_icon
        FROM jobs j
        LEFT JOIN master_job_categories c ON j.job_category_id = c.id
        LEFT JOIN master_work_modes w ON j.work_mode_id = w.id
        LEFT JOIN master_employment_types e ON j.employment_type_id = e.id
        LEFT JOIN master_experience_levels ex ON j.experience_level_id = ex.id
        WHERE j.job_category_id = ? 
        AND j.id != ?
        AND j.is_active = 1
        AND (j.application_deadline IS NULL OR j.application_deadline >= CURDATE())
        ORDER BY j.posted_date DESC
        LIMIT 6");
    $stmt->execute([$job['job_category_id'], $job['id']]);
    $relatedJobs = $stmt->fetchAll();
}

// Update view count
$updateViews = $pdo->prepare("UPDATE jobs SET view_count = view_count + 1 WHERE id = ?");
$updateViews->execute([$job['id']]);

// SEO Meta Tags
$pageTitle = $job['title'] . ' at ' . $job['company'] . ' - Job Portal';
$metaDescription = substr(strip_tags($job['description']), 0, 155) . '... Apply now for this ' . ($job['type_name'] ?: 'job') . ' position in ' . $job['location'];

include 'includes/header.php';
?>

<style>
/* Professional Job Details Page - Enhanced */
.job-details-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

/* Breadcrumb */
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--gray-600);
    flex-wrap: wrap;
}

.breadcrumb a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb-separator {
    color: var(--gray-400);
}

/* Back Button */
.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    margin-bottom: 2rem;
    transition: gap 0.2s;
}

.back-link:hover {
    gap: 0.75rem;
    color: var(--primary-hover);
}

/* Quick Stats Bar */
.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    text-align: center;
    box-shadow: var(--shadow-md);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-4px);
}

.stat-card.salary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card.vacancies {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card.deadline {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.stat-card.views {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
}

/* Job Header */
.job-header {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
}

.company-info {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.company-logo-large {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 700;
    flex-shrink: 0;
    box-shadow: var(--shadow);
}

.job-title-section {
    flex-grow: 1;
}

.job-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
}

.company-name {
    font-size: 1.25rem;
    color: var(--gray-600);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.company-website {
    color: var(--primary);
    text-decoration: none;
    font-size: 0.9375rem;
}

.company-website:hover {
    text-decoration: underline;
}

/* Job Meta */
.job-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-200);
}

.meta-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--gray-50);
    border-radius: var(--radius);
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--gray-700);
    border: 1px solid var(--gray-200);
}

/* Main Content Area */
.content-wrapper {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 2rem;
    align-items: start;
}

.main-content {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
}

.content-section {
    margin-bottom: 3rem;
}

.content-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 1.5rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--gray-200);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.job-description {
    font-size: 1rem;
    line-height: 1.8;
    color: var(--gray-700);
    white-space: pre-wrap;
}

/* Info Cards */
.info-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
}

.info-card {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 1.25rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.info-card-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.info-card-content h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.875rem;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.info-card-content p {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
}

/* Important Dates Timeline */
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--gray-300);
}

.timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 0.25rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--primary);
}

.timeline-date {
    font-weight: 700;
    color: var(--primary);
    margin: 0 0 0.25rem 0;
    font-size: 1.125rem;
}

.timeline-label {
    color: var(--gray-600);
    margin: 0;
    font-size: 0.9375rem;
}

/* Fee Table */
.fee-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.fee-table th,
.fee-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.fee-table th {
    background: var(--gray-50);
    font-weight: 600;
    color: var(--gray-700);
}

.fee-table td {
    font-weight: 600;
    color: var(--gray-900);
}

.fee-amount {
    color: var(--primary);
    font-size: 1.125rem;
}

.fee-free {
    color: var(--success);
}

/* Details Grid */
.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1.25rem;
}

.detail-item {
    padding: 1.25rem;
    background: var(--gray-50);
    border-radius: var(--radius);
    border-left: 3px solid var(--primary);
}

.detail-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 0.5rem 0;
}

.detail-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Sidebar */
.sidebar {
    position: sticky;
    top: 100px;
}

.apply-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 2px solid var(--primary);
    margin-bottom: 1.5rem;
}

.apply-card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 1.5rem 0;
}

.apply-btn {
    display: block;
    width: 100%;
    padding: 1rem 1.5rem;
    background: var(--primary);
    color: white;
    text-align: center;
    text-decoration: none;
    border-radius: var(--radius);
    font-weight: 700;
    font-size: 1.125rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
}

.apply-btn:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    color: white;
}

.apply-btn.disabled {
    background: var(--gray-400);
    cursor: not-allowed;
    transform: none;
}

.apply-btn.disabled:hover {
    background: var(--gray-400);
    transform: none;
}

.deadline-info {
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: var(--radius);
    font-size: 0.9375rem;
}

.deadline-info.urgent {
    background: #fef3c7;
    border: 1px solid var(--warning);
    color: #92400e;
}

.deadline-info.normal {
    background: #dbeafe;
    border: 1px solid var(--info);
    color: #1e40af;
}

.deadline-info.expired {
    background: #fee2e2;
    border: 1px solid var(--danger);
    color: #991b1b;
}

.deadline-info strong {
    display: block;
    margin-bottom: 0.25rem;
}

/* Share Section */
.share-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--gray-200);
}

.share-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 1rem 0;
}

.share-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: var(--transition);
}

.share-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.share-btn.facebook {
    background: #1877f2;
    color: white;
}

.share-btn.twitter {
    background: #1da1f2;
    color: white;
}

.share-btn.linkedin {
    background: #0077b5;
    color: white;
}

.share-btn.whatsapp {
    background: #25d366;
    color: white;
}

/* Highlight Box */
.highlight-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    margin-bottom: 1.5rem;
}

.highlight-box h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
}

.highlight-box p {
    margin: 0;
    font-size: 0.9375rem;
    opacity: 0.95;
}
/* Enhanced Related Jobs Section */
.related-section {
    margin-top: 4rem;
    padding: 2rem;
    background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
    border-radius: var(--radius-xl);
}

.related-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gray-200);
}

.related-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
}

.view-all-link {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9375rem;
    transition: var(--transition);
}

.view-all-link:hover {
    color: var(--primary-hover);
    text-decoration: underline;
}

.related-jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

.related-job-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: 0;
    box-shadow: var(--shadow);
    border: 2px solid var(--gray-200);
    transition: all 0.3s ease;
    text-decoration: none;
    display: block;
    color: inherit;
    overflow: hidden;
    position: relative;
}

.related-job-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border-color: var(--primary);
}

.related-job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-hover));
    opacity: 0;
    transition: opacity 0.3s;
}

.related-job-card:hover::before {
    opacity: 1;
}

.related-job-logo {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 700;
    margin: 1.5rem 1.5rem 0 1.5rem;
    box-shadow: var(--shadow-md);
}

.related-job-content {
    padding: 1rem 1.5rem 1.5rem 1.5rem;
}

.related-job-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.related-job-company {
    font-size: 0.9375rem;
    color: var(--gray-600);
    margin: 0 0 0.75rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.company-icon {
    font-size: 1rem;
}

.related-job-preview {
    font-size: 0.875rem;
    color: var(--gray-500);
    line-height: 1.5;
    margin: 0 0 1rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.related-job-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius);
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--gray-700);
}

.info-icon {
    font-size: 1rem;
}

.related-job-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.related-job-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
    font-size: 0.8125rem;
}

.posted-time {
    color: var(--gray-500);
}

.deadline-badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 0.75rem;
}

.deadline-badge.urgent {
    background: #fee2e2;
    color: #991b1b;
}

.deadline-badge.warning {
    background: #fef3c7;
    color: #92400e;
}
@media (max-width: 991px) {
    .content-wrapper {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        position: static;
        order: -1;
    }
    
    .quick-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 767px) {
    .job-header {
        padding: 1.5rem;
    }
    
    .company-info {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .company-name {
        justify-content: center;
    }
    
    .job-title {
        font-size: 1.5rem;
    }
    
    .main-content {
        padding: 1.5rem;
    }
    
    .quick-stats {
        grid-template-columns: 1fr;
    }
    
    .info-cards {
        grid-template-columns: 1fr;
    }
    
    .details-grid {
        grid-template-columns: 1fr;
    }
    
    .share-buttons {
        grid-template-columns: 1fr;
    }
    
    /* Related jobs responsive (keep existing) */
    .related-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .related-jobs-grid {
        grid-template-columns: 1fr;
    }
    
    .related-job-info-grid {
        grid-template-columns: 1fr;
    }
}

/* Responsive */
@media (max-width: 767px) {
    .related-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .related-jobs-grid {
        grid-template-columns: 1fr;
    }
    
    .related-job-info-grid {
        grid-template-columns: 1fr;
    }
}

</style>

<div class="job-details-container">
    <!-- Breadcrumb -->
 <!-- CORRECT - Absolute paths -->
<a href="/job_poster/">Home</a>
<a href="/job_poster/">Jobs</a>
<a href="/job_poster/?category=<?php echo $job['job_category_id']; ?>">
<a href="/job_poster/" class="back-link">


    <!-- Back Button -->
    <a href="index.php" class="back-link">
        ‚Üê Back to All Jobs
    </a>

    <!-- Quick Stats -->
    <?php if ($job['total_vacancies'] || $job['salary_min'] || $job['application_deadline'] || $job['view_count']): ?>
    <div class="quick-stats">
        <?php if ($job['total_vacancies']): ?>
        <div class="stat-card vacancies">
            <p class="stat-number"><?php echo number_format($job['total_vacancies']); ?></p>
            <p class="stat-label">Total Vacancies</p>
        </div>
        <?php endif; ?>

        <?php if ($job['salary_min']): ?>
        <div class="stat-card salary">
            <p class="stat-number">‚Çπ<?php echo number_format($job['salary_min']); ?></p>
            <p class="stat-label">Minimum Salary/Month</p>
        </div>
        <?php endif; ?>

        <?php if ($job['application_deadline'] && !$isExpired): ?>
        <div class="stat-card deadline">
            <p class="stat-number"><?php echo $daysUntilDeadline >= 0 ? $daysUntilDeadline : 0; ?></p>
            <p class="stat-label">Days Left to Apply</p>
        </div>
        <?php endif; ?>

        <?php if ($job['view_count']): ?>
        <div class="stat-card views">
            <p class="stat-number"><?php echo number_format($job['view_count']); ?></p>
            <p class="stat-label">Views</p>
        </div>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <!-- Job Header -->
    <div class="job-header">
        <div class="company-info">
            <div class="company-logo-large">
                <?php echo strtoupper(substr($job['company'], 0, 2)); ?>
            </div>
            <div class="job-title-section">
                <h1 class="job-title"><?php echo htmlspecialchars($job['title']); ?></h1>
                <p class="company-name">
                    <span>üè¢ <?php echo htmlspecialchars($job['company']); ?></span>
                    <?php if ($job['official_website']): ?>
                        | <a href="<?php echo htmlspecialchars($job['official_website']); ?>" target="_blank" rel="noopener" class="company-website">Visit Website ‚Üó</a>
                    <?php endif; ?>
                </p>
            </div>
        </div>

        <div class="job-meta">
            <?php if ($job['location']): ?>
                <span class="meta-tag">üìç <?php echo htmlspecialchars($job['location']); ?></span>
            <?php endif; ?>
            <?php if ($job['mode_name']): ?>
                <span class="meta-tag"><?php echo $job['work_mode_icon']; ?> <?php echo htmlspecialchars($job['mode_name']); ?></span>
            <?php endif; ?>
            <?php if ($job['type_name']): ?>
                <span class="meta-tag"><?php echo $job['employment_icon']; ?> <?php echo htmlspecialchars($job['type_name']); ?></span>
            <?php endif; ?>
            <?php if ($job['level_name']): ?>
                <span class="meta-tag"><?php echo $job['experience_icon']; ?> <?php echo htmlspecialchars($job['level_name']); ?></span>
            <?php endif; ?>
            <span class="meta-tag">üìÖ Posted <?php echo date('M d, Y', strtotime($job['posted_date'])); ?></span>
        </div>
    </div>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Job Description -->
            <?php if ($job['description']): ?>
            <div class="content-section">
                <h2 class="section-title">üìÑ About This Role</h2>
                <div class="job-description">
                    <?php echo nl2br(htmlspecialchars($job['description'])); ?>
                </div>
            </div>
            <?php endif; ?>

            <!-- Age Eligibility -->
            <?php if ($job['age_limit_min'] || $job['age_limit_max']): ?>
            <div class="content-section">
                <h2 class="section-title">üìÖ Age Eligibility</h2>
                <div class="info-cards">
                    <?php if ($job['age_limit_min']): ?>
                    <div class="info-card">
                        <div class="info-card-icon">üë§</div>
                        <div class="info-card-content">
                            <h4>Minimum Age</h4>
                            <p><?php echo $job['age_limit_min']; ?> Years</p>
                        </div>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['age_limit_max']): ?>
                    <div class="info-card">
                        <div class="info-card-icon">üë¥</div>
                        <div class="info-card-content">
                            <h4>Maximum Age</h4>
                            <p><?php echo $job['age_limit_max']; ?> Years</p>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            <?php endif; ?>

            <!-- Application Fees -->
            <?php if ($job['application_fee_general'] !== null || $job['application_fee_obc'] !== null || $job['application_fee_sc_st'] !== null): ?>
            <div class="content-section">
                <h2 class="section-title">üí≥ Application Fee</h2>
                <table class="fee-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Fee Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if ($job['application_fee_general'] !== null): ?>
                        <tr>
                            <td>General / OBC (Unreserved)</td>
                            <td class="fee-amount <?php echo $job['application_fee_general'] == 0 ? 'fee-free' : ''; ?>">
                                <?php echo $job['application_fee_general'] == 0 ? 'FREE' : '‚Çπ' . number_format($job['application_fee_general'], 2); ?>
                            </td>
                        </tr>
                        <?php endif; ?>

                        <?php if ($job['application_fee_obc'] !== null): ?>
                        <tr>
                            <td>OBC / EWS</td>
                            <td class="fee-amount <?php echo $job['application_fee_obc'] == 0 ? 'fee-free' : ''; ?>">
                                <?php echo $job['application_fee_obc'] == 0 ? 'FREE' : '‚Çπ' . number_format($job['application_fee_obc'], 2); ?>
                            </td>
                        </tr>
                        <?php endif; ?>

                        <?php if ($job['application_fee_sc_st'] !== null): ?>
                        <tr>
                            <td>SC / ST / PWD</td>
                            <td class="fee-amount <?php echo $job['application_fee_sc_st'] == 0 ? 'fee-free' : ''; ?>">
                                <?php echo $job['application_fee_sc_st'] == 0 ? 'FREE' : '‚Çπ' . number_format($job['application_fee_sc_st'], 2); ?>
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
                <?php if ($job['payment_mode']): ?>
                <p style="margin-top: 1rem; color: var(--gray-600); font-size: 0.9375rem;">
                    <strong>Payment Mode:</strong> <?php echo htmlspecialchars($job['payment_mode']); ?>
                </p>
                <?php endif; ?>
            </div>
            <?php endif; ?>

            <!-- Important Dates -->
            <?php if ($job['notification_date'] || $job['application_deadline'] || $job['exam_date'] || $job['result_date']): ?>
            <div class="content-section">
                <h2 class="section-title">üìÜ Important Dates</h2>
                <div class="timeline">
                    <?php if ($job['notification_date']): ?>
                    <div class="timeline-item">
                        <p class="timeline-date"><?php echo date('F d, Y', strtotime($job['notification_date'])); ?></p>
                        <p class="timeline-label">Notification Release Date</p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['posted_date']): ?>
                    <div class="timeline-item">
                        <p class="timeline-date"><?php echo date('F d, Y', strtotime($job['posted_date'])); ?></p>
                        <p class="timeline-label">Application Start Date</p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['application_deadline']): ?>
                    <div class="timeline-item">
                        <p class="timeline-date"><?php echo date('F d, Y', strtotime($job['application_deadline'])); ?></p>
                        <p class="timeline-label">Last Date to Apply</p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['exam_date']): ?>
                    <div class="timeline-item">
                        <p class="timeline-date"><?php echo date('F d, Y', strtotime($job['exam_date'])); ?></p>
                        <p class="timeline-label">Examination Date</p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['result_date']): ?>
                    <div class="timeline-item">
                        <p class="timeline-date"><?php echo date('F d, Y', strtotime($job['result_date'])); ?></p>
                        <p class="timeline-label">Expected Result Date</p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            <?php endif; ?>

            <!-- Job Details -->
            <div class="content-section">
                <h2 class="section-title">üíº Job Details</h2>
                <div class="details-grid">
                    <?php if ($job['category_name']): ?>
                    <div class="detail-item">
                        <p class="detail-label">Category</p>
                        <p class="detail-value">
                            <?php echo $job['category_icon']; ?>
                            <?php echo htmlspecialchars($job['category_name']); ?>
                        </p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['qualification_name']): ?>
                    <div class="detail-item">
                        <p class="detail-label">Qualification Required</p>
                        <p class="detail-value">
                            üéì <?php echo htmlspecialchars($job['qualification_name']); ?>
                        </p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['department_name']): ?>
                    <div class="detail-item">
                        <p class="detail-label">Department</p>
                        <p class="detail-value">
                            üèõÔ∏è <?php echo htmlspecialchars($job['department_name']); ?>
                        </p>
                    </div>
                    <?php endif; ?>

                    <?php if ($job['state_name']): ?>
                    <div class="detail-item">
                        <p class="detail-label">State/Region</p>
                        <p class="detail-value">
                            üìç <?php echo htmlspecialchars($job['state_name']); ?>
                        </p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Apply Card -->
            <div class="apply-card">
                <h3 class="apply-card-title">Apply for this job</h3>

                <?php if ($isExpired): ?>
                    <button class="apply-btn disabled" disabled>
                        ‚ùå Application Closed
                    </button>
                    <div class="deadline-info expired">
                        <strong>Applications Closed</strong>
                        Deadline was <?php echo date('M d, Y', strtotime($job['application_deadline'])); ?>
                    </div>
                <?php else: ?>
                    <a href="<?php echo htmlspecialchars($job['job_link']); ?>" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="apply-btn"
                       onclick="trackApplyClick(<?php echo $job['id']; ?>)">
                        Apply Now ‚Üí
                    </a>

                    <?php if ($job['application_deadline']): ?>
                        <div class="deadline-info <?php echo $daysUntilDeadline <= 3 ? 'urgent' : 'normal'; ?>">
                            <strong>‚è∞ Application Deadline</strong>
                            <?php echo date('F d, Y', strtotime($job['application_deadline'])); ?>
                            <?php if ($daysUntilDeadline >= 0 && $daysUntilDeadline <= 7): ?>
                                <br><strong><?php echo $daysUntilDeadline; ?> day<?php echo $daysUntilDeadline != 1 ? 's' : ''; ?> remaining!</strong>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>
                <?php endif; ?>

                <!-- Share Section -->
                <div class="share-section">
                    <p class="share-title">üì§ Share This Job</p>
                    <div class="share-buttons">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=<?php echo urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']); ?>" 
                           target="_blank" 
                           class="share-btn facebook">
                            Facebook
                        </a>
                        <a href="https://twitter.com/intent/tweet?url=<?php echo urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']); ?>&text=<?php echo urlencode($job['title'] . ' at ' . $job['company']); ?>" 
                           target="_blank" 
                           class="share-btn twitter">
                            Twitter
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url=<?php echo urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']); ?>" 
                           target="_blank" 
                           class="share-btn linkedin">
                            LinkedIn
                        </a>
                        <a href="https://wa.me/?text=<?php echo urlencode($job['title'] . ' at ' . $job['company'] . ' - ' . 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']); ?>" 
                           target="_blank" 
                           class="share-btn whatsapp">
                            WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Info Highlight -->
            <?php if ($job['total_vacancies'] || $job['salary_min']): ?>
            <div class="highlight-box">
                <h4>üí° Quick Info</h4>
                <?php if ($job['total_vacancies']): ?>
                <p>üë• <strong><?php echo number_format($job['total_vacancies']); ?></strong> vacancies available</p>
                <?php endif; ?>
                <?php if ($job['salary_min']): ?>
                <p>üí∞ Salary starts from <strong>‚Çπ<?php echo number_format($job['salary_min']); ?></strong></p>
                <?php endif; ?>
            </div>
            <?php endif; ?>
        </div>
    </div>

    <!-- Related Jobs -->
  
    <?php if (count($relatedJobs) > 0): ?>
    <div class="related-section">
        <div class="related-header">
            <h2 class="related-title">üîó Similar Jobs You Might Like</h2>
            <a href="/job_poster/?category=<?php echo $job['job_category_id']; ?>" class="view-all-link">
                View All <?php echo htmlspecialchars($job['category_name']); ?> Jobs ‚Üí
            </a>
        </div>
        
        <div class="related-jobs-grid">
            <?php foreach ($relatedJobs as $relJob): ?>
                <a href="/job_poster/jobs/<?php echo urlencode($relJob['slug'] ?: 'job-' . $relJob['id']); ?>" class="related-job-card">
                    <!-- Company Logo Badge -->
                    <div class="related-job-logo">
                        <?php echo strtoupper(substr($relJob['company'], 0, 2)); ?>
                    </div>
                    
                    <div class="related-job-content">
                        <h3 class="related-job-title"><?php echo htmlspecialchars($relJob['title']); ?></h3>
                        <p class="related-job-company">
                            <span class="company-icon">üè¢</span>
                            <?php echo htmlspecialchars($relJob['company']); ?>
                        </p>

                        <!-- Job Preview -->
                        <?php if ($relJob['description']): ?>
                        <p class="related-job-preview">
                            <?php echo htmlspecialchars(substr(strip_tags($relJob['description']), 0, 80)); ?>...
                        </p>
                        <?php endif; ?>

                        <!-- Job Info Grid -->
                        <div class="related-job-info-grid">
                            <?php if ($relJob['location']): ?>
                            <div class="info-item">
                                <span class="info-icon">üìç</span>
                                <span><?php echo htmlspecialchars($relJob['location']); ?></span>
                            </div>
                            <?php endif; ?>
                            
                            <?php if ($relJob['total_vacancies']): ?>
                            <div class="info-item">
                                <span class="info-icon">üë•</span>
                                <span><?php echo number_format($relJob['total_vacancies']); ?> Vacancies</span>
                            </div>
                            <?php endif; ?>
                            
                            <?php if ($relJob['salary_min']): ?>
                            <div class="info-item">
                                <span class="info-icon">üí∞</span>
                                <span>‚Çπ<?php echo number_format($relJob['salary_min']); ?>/mo</span>
                            </div>
                            <?php endif; ?>
                        </div>

                        <!-- Badges -->
                        <div class="related-job-meta">
                            <?php if ($relJob['mode_name']): ?>
                                <span class="job-badge job-badge-blue">
                                    <?php echo $relJob['work_mode_icon']; ?> <?php echo htmlspecialchars($relJob['mode_name']); ?>
                                </span>
                            <?php endif; ?>
                            <?php if ($relJob['type_name']): ?>
                                <span class="job-badge job-badge-teal">
                                    <?php echo $relJob['employment_icon']; ?> <?php echo htmlspecialchars($relJob['type_name']); ?>
                                </span>
                            <?php endif; ?>
                            <?php if ($relJob['level_name']): ?>
                                <span class="job-badge job-badge-green">
                                    <?php echo $relJob['experience_icon']; ?> <?php echo htmlspecialchars($relJob['level_name']); ?>
                                </span>
                            <?php endif; ?>
                        </div>

                        <!-- Footer Info -->
                        <div class="related-job-footer">
                            <span class="posted-time">
                                üìÖ <?php echo date('M d, Y', strtotime($relJob['posted_date'])); ?>
                            </span>
                            <?php if ($relJob['application_deadline']): ?>
                                <?php
                                $relDeadline = strtotime($relJob['application_deadline']);
                                $relToday = strtotime(date('Y-m-d'));
                                $relDaysLeft = floor(($relDeadline - $relToday) / (60 * 60 * 24));
                                ?>
                                <?php if ($relDaysLeft >= 0 && $relDaysLeft <= 7): ?>
                                    <span class="deadline-badge <?php echo $relDaysLeft <= 3 ? 'urgent' : 'warning'; ?>">
                                        ‚è∞ <?php echo $relDaysLeft; ?> day<?php echo $relDaysLeft != 1 ? 's' : ''; ?> left
                                    </span>
                                <?php endif; ?>
                            <?php endif; ?>
                        </div>
                    </div>
                </a>
            <?php endforeach; ?>
        </div>
    </div>
    <?php endif; ?>

</div>

<script>
// Track apply button clicks
function trackApplyClick(jobId) {
    fetch('api/track_apply.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ job_id: jobId })
    }).catch(err => console.error('Tracking error:', err));
}
</script>

<?php include 'includes/footer.php'; ?>